<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Veil: src/veil_shmem.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Veil
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('veil__shmem_8c.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">veil_shmem.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Functions for dealing with veil shared memory.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;postgres.h&quot;</code><br />
<code>#include &quot;utils/hsearch.h&quot;</code><br />
<code>#include &quot;storage/pg_shmem.h&quot;</code><br />
<code>#include &quot;storage/shmem.h&quot;</code><br />
<code>#include &quot;storage/lwlock.h&quot;</code><br />
<code>#include &quot;storage/procarray.h&quot;</code><br />
<code>#include &quot;access/xact.h&quot;</code><br />
<code>#include &quot;access/transam.h&quot;</code><br />
<code>#include &quot;miscadmin.h&quot;</code><br />
<code>#include &quot;<a class="el" href="veil__version_8h_source.html">veil_version.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="veil__shmem_8h_source.html">veil_shmem.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="veil__funcs_8h_source.html">veil_funcs.h</a>&quot;</code><br />
</div>
<p><a href="veil__shmem_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a30f9f40d3b839a62d868567c2a74c3d6"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="veil__shmem_8c.html#a30f9f40d3b839a62d868567c2a74c3d6">OTHER_CONTEXT</a>(x)&#160;&#160;&#160;(x ? 0: 1)</td></tr>
<tr class="memdesc:a30f9f40d3b839a62d868567c2a74c3d6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Return the index of the other context from the one supplied.  <a href="#a30f9f40d3b839a62d868567c2a74c3d6">More...</a><br /></td></tr>
<tr class="separator:a30f9f40d3b839a62d868567c2a74c3d6"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a03a95dadc33da66082799a0ab85fd9c6"><td class="memItemLeft" align="right" valign="top">static LWLock *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="veil__shmem_8c.html#a03a95dadc33da66082799a0ab85fd9c6">NextLWLock</a> ()</td></tr>
<tr class="memdesc:a03a95dadc33da66082799a0ab85fd9c6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Return the next LWLock from our tranche.  <a href="#a03a95dadc33da66082799a0ab85fd9c6">More...</a><br /></td></tr>
<tr class="separator:a03a95dadc33da66082799a0ab85fd9c6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6822496ec3bdaec728859d44564ed1b7"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="veil__shmem_8c.html#a6822496ec3bdaec728859d44564ed1b7">_PG_init</a> ()</td></tr>
<tr class="memdesc:a6822496ec3bdaec728859d44564ed1b7"><td class="mdescLeft">&#160;</td><td class="mdescRight">Veil's startup function.  <a href="#a6822496ec3bdaec728859d44564ed1b7">More...</a><br /></td></tr>
<tr class="separator:a6822496ec3bdaec728859d44564ed1b7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab8c1460e5b33ba9e8eb556206320f49f"><td class="memItemLeft" align="right" valign="top">static HTAB *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="veil__shmem_8c.html#ab8c1460e5b33ba9e8eb556206320f49f">create_shared_hash</a> (const char *hashname)</td></tr>
<tr class="memdesc:ab8c1460e5b33ba9e8eb556206320f49f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Create/attach to the shared hash identified by hashname.  <a href="#ab8c1460e5b33ba9e8eb556206320f49f">More...</a><br /></td></tr>
<tr class="separator:ab8c1460e5b33ba9e8eb556206320f49f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1f37298e158c266d41dfcc0d06dc4e05"><td class="memItemLeft" align="right" valign="top">static HTAB *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="veil__shmem_8c.html#a1f37298e158c266d41dfcc0d06dc4e05">get_hash0</a> ()</td></tr>
<tr class="memdesc:a1f37298e158c266d41dfcc0d06dc4e05"><td class="mdescLeft">&#160;</td><td class="mdescRight">Return reference to the HTAB for the shared hash associated with context 0.  <a href="#a1f37298e158c266d41dfcc0d06dc4e05">More...</a><br /></td></tr>
<tr class="separator:a1f37298e158c266d41dfcc0d06dc4e05"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5c1bdec055ddd427b5dded0a66ef45fd"><td class="memItemLeft" align="right" valign="top">static HTAB *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="veil__shmem_8c.html#a5c1bdec055ddd427b5dded0a66ef45fd">get_hash1</a> ()</td></tr>
<tr class="memdesc:a5c1bdec055ddd427b5dded0a66ef45fd"><td class="mdescLeft">&#160;</td><td class="mdescRight">Return reference to the HTAB for the shared hash associated with context 1.  <a href="#a5c1bdec055ddd427b5dded0a66ef45fd">More...</a><br /></td></tr>
<tr class="separator:a5c1bdec055ddd427b5dded0a66ef45fd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5948ffbe24049b0b8ae1d6c229fe8020"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="structMemContext.html">MemContext</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="veil__shmem_8c.html#a5948ffbe24049b0b8ae1d6c229fe8020">get_shmem_context</a> (char *name, size_t size, bool *p_found)</td></tr>
<tr class="memdesc:a5948ffbe24049b0b8ae1d6c229fe8020"><td class="mdescLeft">&#160;</td><td class="mdescRight">Allocate or attach to, a new chunk of shared memory for a named memory context.  <a href="#a5948ffbe24049b0b8ae1d6c229fe8020">More...</a><br /></td></tr>
<tr class="separator:a5948ffbe24049b0b8ae1d6c229fe8020"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a56ac7d29cee7549d8ba7c773c20b3059"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="veil__shmem_8c.html#a56ac7d29cee7549d8ba7c773c20b3059">shmalloc_init</a> (void)</td></tr>
<tr class="memdesc:a56ac7d29cee7549d8ba7c773c20b3059"><td class="mdescLeft">&#160;</td><td class="mdescRight">Attach to, creating and initialising as necessary, the shared memory control structure.  <a href="#a56ac7d29cee7549d8ba7c773c20b3059">More...</a><br /></td></tr>
<tr class="separator:a56ac7d29cee7549d8ba7c773c20b3059"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a70eb6a014556b540cb3ca9d1102bd9b3"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="veil__shmem_8c.html#a70eb6a014556b540cb3ca9d1102bd9b3">get_cur_context_id</a> ()</td></tr>
<tr class="memdesc:a70eb6a014556b540cb3ca9d1102bd9b3"><td class="mdescLeft">&#160;</td><td class="mdescRight">Return the id (index) of the current context for this session.  <a href="#a70eb6a014556b540cb3ca9d1102bd9b3">More...</a><br /></td></tr>
<tr class="separator:a70eb6a014556b540cb3ca9d1102bd9b3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab86d819c1dfe4f25ed4a7094edf473cd"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="structMemContext.html">MemContext</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="veil__shmem_8c.html#ab86d819c1dfe4f25ed4a7094edf473cd">get_cur_context</a> ()</td></tr>
<tr class="memdesc:ab86d819c1dfe4f25ed4a7094edf473cd"><td class="mdescLeft">&#160;</td><td class="mdescRight">Return pointer to shared memory allocated for the current context.  <a href="#ab86d819c1dfe4f25ed4a7094edf473cd">More...</a><br /></td></tr>
<tr class="separator:ab86d819c1dfe4f25ed4a7094edf473cd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a227be00ef6a272b3542f8a557921cc68"><td class="memItemLeft" align="right" valign="top">static void *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="veil__shmem_8c.html#a227be00ef6a272b3542f8a557921cc68">do_vl_shmalloc</a> (<a class="el" href="structMemContext.html">MemContext</a> *context, size_t size)</td></tr>
<tr class="memdesc:a227be00ef6a272b3542f8a557921cc68"><td class="mdescLeft">&#160;</td><td class="mdescRight">Dynamically allocate a piece of shared memory from the current context, doing no locking.  <a href="#a227be00ef6a272b3542f8a557921cc68">More...</a><br /></td></tr>
<tr class="separator:a227be00ef6a272b3542f8a557921cc68"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a29b6f83f94963d116e3ae668409d4e64"><td class="memItemLeft" align="right" valign="top">void *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="veil__shmem_8c.html#a29b6f83f94963d116e3ae668409d4e64">vl_shmalloc</a> (size_t size)</td></tr>
<tr class="memdesc:a29b6f83f94963d116e3ae668409d4e64"><td class="mdescLeft">&#160;</td><td class="mdescRight">Dynamically allocate a piece of shared memory from the current context.  <a href="#a29b6f83f94963d116e3ae668409d4e64">More...</a><br /></td></tr>
<tr class="separator:a29b6f83f94963d116e3ae668409d4e64"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae0c62be7edc4694bd88843fb2f1c3374"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="veil__shmem_8c.html#ae0c62be7edc4694bd88843fb2f1c3374">vl_free</a> (void *mem)</td></tr>
<tr class="memdesc:ae0c62be7edc4694bd88843fb2f1c3374"><td class="mdescLeft">&#160;</td><td class="mdescRight">Free a piece of shared memory within the current context.  <a href="#ae0c62be7edc4694bd88843fb2f1c3374">More...</a><br /></td></tr>
<tr class="separator:ae0c62be7edc4694bd88843fb2f1c3374"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a34c7062e411af6d7ec1c2120e9e051ef"><td class="memItemLeft" align="right" valign="top">HTAB *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="veil__shmem_8c.html#a34c7062e411af6d7ec1c2120e9e051ef">vl_get_shared_hash</a> ()</td></tr>
<tr class="memdesc:a34c7062e411af6d7ec1c2120e9e051ef"><td class="mdescLeft">&#160;</td><td class="mdescRight">Return the shared hash for the current context.  <a href="#a34c7062e411af6d7ec1c2120e9e051ef">More...</a><br /></td></tr>
<tr class="separator:a34c7062e411af6d7ec1c2120e9e051ef"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a77032dd4e670f5ffcfed0613b636dcfd"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="veil__shmem_8c.html#a77032dd4e670f5ffcfed0613b636dcfd">clear_hash</a> (HTAB *hash)</td></tr>
<tr class="memdesc:a77032dd4e670f5ffcfed0613b636dcfd"><td class="mdescLeft">&#160;</td><td class="mdescRight">Reset one of the shared hashes.  <a href="#a77032dd4e670f5ffcfed0613b636dcfd">More...</a><br /></td></tr>
<tr class="separator:a77032dd4e670f5ffcfed0613b636dcfd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3310bc14291d9f102ade89066450df5a"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="veil__shmem_8c.html#a3310bc14291d9f102ade89066450df5a">vl_prepare_context_switch</a> ()</td></tr>
<tr class="memdesc:a3310bc14291d9f102ade89066450df5a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Prepare for a switch to the alternate context.  <a href="#a3310bc14291d9f102ade89066450df5a">More...</a><br /></td></tr>
<tr class="separator:a3310bc14291d9f102ade89066450df5a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9d1285bebe16c01ef93b9c049623a2ca"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="veil__shmem_8c.html#a9d1285bebe16c01ef93b9c049623a2ca">vl_complete_context_switch</a> ()</td></tr>
<tr class="memdesc:a9d1285bebe16c01ef93b9c049623a2ca"><td class="mdescLeft">&#160;</td><td class="mdescRight">Complete the context switch started by <a class="el" href="veil__shmem_8c.html#a3310bc14291d9f102ade89066450df5a" title="Prepare for a switch to the alternate context. ">vl_prepare_context_switch()</a>.  <a href="#a9d1285bebe16c01ef93b9c049623a2ca">More...</a><br /></td></tr>
<tr class="separator:a9d1285bebe16c01ef93b9c049623a2ca"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acb516eaf03f8422e4fb62593db4d06bb"><td class="memItemLeft" align="right" valign="top"><a id="acb516eaf03f8422e4fb62593db4d06bb"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="veil__shmem_8c.html#acb516eaf03f8422e4fb62593db4d06bb">vl_force_context_switch</a> ()</td></tr>
<tr class="memdesc:acb516eaf03f8422e4fb62593db4d06bb"><td class="mdescLeft">&#160;</td><td class="mdescRight">In desparation, if we are unable to complete a context switch, we should use this function. <br /></td></tr>
<tr class="separator:acb516eaf03f8422e4fb62593db4d06bb"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a47d50f6fb8b42afe3de97c547d35fdb0"><td class="memItemLeft" align="right" valign="top"><a id="a47d50f6fb8b42afe3de97c547d35fdb0"></a>
static <a class="el" href="structShmemCtl.html">ShmemCtl</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="veil__shmem_8c.html#a47d50f6fb8b42afe3de97c547d35fdb0">shared_meminfo</a> = NULL</td></tr>
<tr class="memdesc:a47d50f6fb8b42afe3de97c547d35fdb0"><td class="mdescLeft">&#160;</td><td class="mdescRight">shared_meminfo provides access to the <a class="el" href="structShmemCtl.html" title="The ShmemCtl structure is the first object allocated from the first chunk of shared memory in context...">ShmemCtl</a> structure allocated in context 0. <br /></td></tr>
<tr class="separator:a47d50f6fb8b42afe3de97c547d35fdb0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae492088f1f58cd72f518025a5b37a775"><td class="memItemLeft" align="right" valign="top">static bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="veil__shmem_8c.html#ae492088f1f58cd72f518025a5b37a775">prepared_for_switch</a> = false</td></tr>
<tr class="memdesc:ae492088f1f58cd72f518025a5b37a775"><td class="mdescLeft">&#160;</td><td class="mdescRight">Whether the current backend is in the process of switching contexts.  <a href="#ae492088f1f58cd72f518025a5b37a775">More...</a><br /></td></tr>
<tr class="separator:ae492088f1f58cd72f518025a5b37a775"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad8f74fa4f1ea4cf7a19a63acc93d9821"><td class="memItemLeft" align="right" valign="top">static LWLockId&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="veil__shmem_8c.html#ad8f74fa4f1ea4cf7a19a63acc93d9821">VeilLWLock</a> = 0</td></tr>
<tr class="memdesc:ad8f74fa4f1ea4cf7a19a63acc93d9821"><td class="mdescLeft">&#160;</td><td class="mdescRight">The LWLock that Veil will use for managing concurrent access to shared memory.  <a href="#ad8f74fa4f1ea4cf7a19a63acc93d9821">More...</a><br /></td></tr>
<tr class="separator:ad8f74fa4f1ea4cf7a19a63acc93d9821"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abde9c524b373dd3b0f8da340ed52061a"><td class="memItemLeft" align="right" valign="top">static LWLockId&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="veil__shmem_8c.html#abde9c524b373dd3b0f8da340ed52061a">InitialLWLock</a> = 0</td></tr>
<tr class="memdesc:abde9c524b373dd3b0f8da340ed52061a"><td class="mdescLeft">&#160;</td><td class="mdescRight">The LWLock to be used while initially setting up shared memory and allocating a veil database-specific LWLock.  <a href="#abde9c524b373dd3b0f8da340ed52061a">More...</a><br /></td></tr>
<tr class="separator:abde9c524b373dd3b0f8da340ed52061a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad27306fcd496142b6c0389a86a21fa7a"><td class="memItemLeft" align="right" valign="top"><a id="ad27306fcd496142b6c0389a86a21fa7a"></a>
static <a class="el" href="structMemContext.html">MemContext</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="veil__shmem_8c.html#ad27306fcd496142b6c0389a86a21fa7a">lwlock_context</a></td></tr>
<tr class="memdesc:ad27306fcd496142b6c0389a86a21fa7a"><td class="mdescLeft">&#160;</td><td class="mdescRight">The <a class="el" href="structMemContext.html" title="MemContexts are large single chunks of shared memory from which smaller allocations may be made...">MemContext</a> that we use to manage our tranche of LWLocks. <br /></td></tr>
<tr class="separator:ad27306fcd496142b6c0389a86a21fa7a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9ffad6bd5b4796cca9ddc357e8b5ae1d"><td class="memItemLeft" align="right" valign="top"><a id="a9ffad6bd5b4796cca9ddc357e8b5ae1d"></a>
static char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="veil__shmem_8c.html#a9ffad6bd5b4796cca9ddc357e8b5ae1d">TRANCHE_NAME</a> = &quot;veil&quot;</td></tr>
<tr class="memdesc:a9ffad6bd5b4796cca9ddc357e8b5ae1d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Name of tranche of LWLocks used by veil. <br /></td></tr>
<tr class="separator:a9ffad6bd5b4796cca9ddc357e8b5ae1d"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Functions for dealing with veil shared memory. </p>
<div class="fragment"><div class="line">Author:       Marc Munro</div><div class="line">Copyright (c) 2005 - 2018 Marc Munro</div><div class="line">License:      BSD</div></div><!-- fragment --><p> This provides dynamic memory allocation, like malloc, from chunks of shared memory allocated from the Postgres shared memory pool. In order to be able to reset and reload shared memory structures while other backends continue to use the existing structures, a shared memory reset creates a new context, or switches to an existing one that is no longer in use. No more than two separate contexts will be created.</p>
<p>Each context of veil shared memory is associated with a shared hash, which is used to store veil's shared variables. A specially named variable, VEIL_SHMEMCTL appears only in context0 and contains a reference to chunk0, and the <a class="el" href="structShmemCtl.html" title="The ShmemCtl structure is the first object allocated from the first chunk of shared memory in context...">ShmemCtl</a> structure. From this structure we can identify the current context, the initial chunks for each active context, and whether a context switch is in progress.</p>
<p>A context switch takes place in 3 steps:</p><ul>
<li>preparation, in which we determine if a context switch is allowed, initialise the new context and record the fact that we are in the process of switching. All subsequent operations in the current backend will work in the new context, while other backends will continue to use the original context</li>
<li>initialisation of the new context, variables, etc. This is done by the user-space function <a class="el" href="veil__funcs_8h.html#a1eb95ff8b9c26ea5494f61dde6f9c31b" title="veil_init(doing_reset bool) returns bool Initialise or reset a veil session. ">veil_init()</a>.</li>
<li>switchover, when all other processes gain access to the newly initialised context. They may continue to use the previous context for the duration of their current transactions.</li>
</ul>
<p>To access shared variable "x" in a new session, the following steps are taken:</p><ul>
<li>We access the hash "VEIL_SHARED1_nnn" (where nnn is the oid of our database). This gives us a reference to the <a class="el" href="structShmemCtl.html" title="The ShmemCtl structure is the first object allocated from the first chunk of shared memory in context...">ShmemCtl</a> structure. We record hash0 and shared_meminfo on the way.</li>
<li>We access ShemCtl to identify the current hash and current context.</li>
<li>We look up variable "x" in the current hash, and if we have to allocate space for it, allocate it from the current context.</li>
</ul>
<p>Note that We use a dynamically allocated LWLock, VeilLWLock to protect our shared control structures. </p>

<p class="definition">Definition in file <a class="el" href="veil__shmem_8c_source.html">veil_shmem.c</a>.</p>
</div><h2 class="groupheader">Macro Definition Documentation</h2>
<a id="a30f9f40d3b839a62d868567c2a74c3d6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a30f9f40d3b839a62d868567c2a74c3d6">&#9670;&nbsp;</a></span>OTHER_CONTEXT</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define OTHER_CONTEXT</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">x</td><td>)</td>
          <td>&#160;&#160;&#160;(x ? 0: 1)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Return the index of the other context from the one supplied. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">x</td><td>the context for which we want the other one.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the opposite context to that of x. </dd></dl>

<p class="definition">Definition at line <a class="el" href="veil__shmem_8c_source.html#l00101">101</a> of file <a class="el" href="veil__shmem_8c_source.html">veil_shmem.c</a>.</p>

<p class="reference">Referenced by <a class="el" href="veil__shmem_8c_source.html#l00337">get_cur_context_id()</a>, <a class="el" href="veil__shmem_8c_source.html#l00678">vl_complete_context_switch()</a>, <a class="el" href="veil__shmem_8c_source.html#l00719">vl_force_context_switch()</a>, and <a class="el" href="veil__shmem_8c_source.html#l00604">vl_prepare_context_switch()</a>.</p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="a03a95dadc33da66082799a0ab85fd9c6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a03a95dadc33da66082799a0ab85fd9c6">&#9670;&nbsp;</a></span>NextLWLock()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static LWLock* NextLWLock </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Return the next LWLock from our tranche. </p>
<p>Note that locking is the responsibility of the caller. </p>

<p class="definition">Definition at line <a class="el" href="veil__shmem_8c_source.html#l00118">118</a> of file <a class="el" href="veil__shmem_8c_source.html">veil_shmem.c</a>.</p>

<p class="reference">References <a class="el" href="veil__shmem_8h_source.html#l00066">MemContext::lwlock_idx</a>, and <a class="el" href="veil__shmem_8h_source.html#l00064">MemContext::lwlock_tranche</a>.</p>

<p class="reference">Referenced by <a class="el" href="veil__shmem_8c_source.html#l00449">shmalloc_init()</a>.</p>

</div>
</div>
<a id="a6822496ec3bdaec728859d44564ed1b7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6822496ec3bdaec728859d44564ed1b7">&#9670;&nbsp;</a></span>_PG_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void _PG_init </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Veil's startup function. </p>
<p>This should be run when the Veil shared library is loaded by postgres. </p>

<p class="definition">Definition at line <a class="el" href="veil__shmem_8c_source.html#l00141">141</a> of file <a class="el" href="veil__shmem_8c_source.html">veil_shmem.c</a>.</p>

<p class="reference">References <a class="el" href="veil__shmem_8c_source.html#l00092">InitialLWLock</a>, <a class="el" href="veil__shmem_8c_source.html#l00111">TRANCHE_NAME</a>, <a class="el" href="veil__config_8c_source.html#l00092">veil_config_init()</a>, <a class="el" href="veil__config_8c_source.html#l00052">veil_dbs_in_cluster()</a>, <a class="el" href="veil__config_8c_source.html#l00082">veil_shmem_context_size()</a>, and <a class="el" href="veil__shmem_8c_source.html#l00085">VeilLWLock</a>.</p>

</div>
</div>
<a id="ab8c1460e5b33ba9e8eb556206320f49f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab8c1460e5b33ba9e8eb556206320f49f">&#9670;&nbsp;</a></span>create_shared_hash()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static HTAB* create_shared_hash </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>hashname</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Create/attach to the shared hash identified by hashname. </p>
<p>Return a pointer to an HTAB that references the shared hash. All locking is handled by the caller.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">hashname</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Pointer to HTAB referencing the shared hash. </dd></dl>

<p class="definition">Definition at line <a class="el" href="veil__shmem_8c_source.html#l00170">170</a> of file <a class="el" href="veil__shmem_8c_source.html">veil_shmem.c</a>.</p>

<p class="reference">References <a class="el" href="veil__datatypes_8h_source.html#l00130">HASH_KEYLEN</a>, <a class="el" href="veil__config_8c_source.html#l00065">veil_shared_hash_elems()</a>, and <a class="el" href="veil__utils_8c_source.html#l00028">vl_malloc()</a>.</p>

<p class="reference">Referenced by <a class="el" href="veil__shmem_8c_source.html#l00199">get_hash0()</a>, and <a class="el" href="veil__shmem_8c_source.html#l00216">get_hash1()</a>.</p>

</div>
</div>
<a id="a1f37298e158c266d41dfcc0d06dc4e05"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1f37298e158c266d41dfcc0d06dc4e05">&#9670;&nbsp;</a></span>get_hash0()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static HTAB* get_hash0 </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Return reference to the HTAB for the shared hash associated with context 0. </p>
<dl class="section return"><dt>Returns</dt><dd>Pointer to HTAB referencing shared hash for context 0. </dd></dl>

<p class="definition">Definition at line <a class="el" href="veil__shmem_8c_source.html#l00199">199</a> of file <a class="el" href="veil__shmem_8c_source.html">veil_shmem.c</a>.</p>

<p class="reference">References <a class="el" href="veil__shmem_8c_source.html#l00170">create_shared_hash()</a>.</p>

<p class="reference">Referenced by <a class="el" href="veil__shmem_8c_source.html#l00719">vl_force_context_switch()</a>, <a class="el" href="veil__shmem_8c_source.html#l00552">vl_get_shared_hash()</a>, and <a class="el" href="veil__shmem_8c_source.html#l00604">vl_prepare_context_switch()</a>.</p>

</div>
</div>
<a id="a5c1bdec055ddd427b5dded0a66ef45fd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5c1bdec055ddd427b5dded0a66ef45fd">&#9670;&nbsp;</a></span>get_hash1()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static HTAB* get_hash1 </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Return reference to the HTAB for the shared hash associated with context 1. </p>
<dl class="section return"><dt>Returns</dt><dd>Pointer to HTAB referencing shared hash for context 1. </dd></dl>

<p class="definition">Definition at line <a class="el" href="veil__shmem_8c_source.html#l00216">216</a> of file <a class="el" href="veil__shmem_8c_source.html">veil_shmem.c</a>.</p>

<p class="reference">References <a class="el" href="veil__shmem_8c_source.html#l00170">create_shared_hash()</a>.</p>

<p class="reference">Referenced by <a class="el" href="veil__shmem_8c_source.html#l00719">vl_force_context_switch()</a>, <a class="el" href="veil__shmem_8c_source.html#l00552">vl_get_shared_hash()</a>, and <a class="el" href="veil__shmem_8c_source.html#l00604">vl_prepare_context_switch()</a>.</p>

</div>
</div>
<a id="a5948ffbe24049b0b8ae1d6c229fe8020"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5948ffbe24049b0b8ae1d6c229fe8020">&#9670;&nbsp;</a></span>get_shmem_context()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="structMemContext.html">MemContext</a>* get_shmem_context </td>
          <td>(</td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool *&#160;</td>
          <td class="paramname"><em>p_found</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Allocate or attach to, a new chunk of shared memory for a named memory context. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">name</td><td>The name </td></tr>
    <tr><td class="paramname">size</td><td>The size of the shared memory chunk to be allocated. </td></tr>
    <tr><td class="paramname">p_found</td><td>Pointer to boolean that will identify whether this chunk has already been initialised.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Pointer to chunk of shared memory. </dd></dl>

<p class="definition">Definition at line <a class="el" href="veil__shmem_8c_source.html#l00240">240</a> of file <a class="el" href="veil__shmem_8c_source.html">veil_shmem.c</a>.</p>

<p class="reference">References <a class="el" href="veil__shmem_8h_source.html#l00055">MemContext::db_id</a>, <a class="el" href="veil__shmem_8h_source.html#l00062">MemContext::limit</a>, <a class="el" href="veil__shmem_8h_source.html#l00059">MemContext::lwlock</a>, <a class="el" href="veil__shmem_8h_source.html#l00066">MemContext::lwlock_idx</a>, <a class="el" href="veil__shmem_8h_source.html#l00064">MemContext::lwlock_tranche</a>, <a class="el" href="veil__shmem_8h_source.html#l00061">MemContext::next</a>, <a class="el" href="veil__shmem_8c_source.html#l00449">shmalloc_init()</a>, <a class="el" href="veil__shmem_8c_source.html#l00111">TRANCHE_NAME</a>, <a class="el" href="veil__config_8c_source.html#l00052">veil_dbs_in_cluster()</a>, <a class="el" href="veil__shmem_8c_source.html#l00085">VeilLWLock</a>, <a class="el" href="veil__query_8c_source.html#l00275">vl_db_exists()</a>, and <a class="el" href="veil__utils_8c_source.html#l00028">vl_malloc()</a>.</p>

<p class="reference">Referenced by <a class="el" href="veil__shmem_8c_source.html#l00449">shmalloc_init()</a>.</p>

</div>
</div>
<a id="a56ac7d29cee7549d8ba7c773c20b3059"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a56ac7d29cee7549d8ba7c773c20b3059">&#9670;&nbsp;</a></span>shmalloc_init()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void shmalloc_init </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Attach to, creating and initialising as necessary, the shared memory control structure. </p>
<p>Record this for the session in shared_meminfo. </p>

<p class="definition">Definition at line <a class="el" href="veil__shmem_8c_source.html#l00449">449</a> of file <a class="el" href="veil__shmem_8c_source.html">veil_shmem.c</a>.</p>

<p class="reference">References <a class="el" href="veil__shmem_8c_source.html#l00387">do_vl_shmalloc()</a>, <a class="el" href="veil__shmem_8c_source.html#l00240">get_shmem_context()</a>, <a class="el" href="veil__shmem_8c_source.html#l00092">InitialLWLock</a>, <a class="el" href="veil__shmem_8h_source.html#l00059">MemContext::lwlock</a>, <a class="el" href="veil__shmem_8h_source.html#l00067">MemContext::memctl</a>, <a class="el" href="veil__shmem_8c_source.html#l00118">NextLWLock()</a>, <a class="el" href="veil__shmem_8c_source.html#l00071">shared_meminfo</a>, <a class="el" href="veil__datatypes_8h_source.html#l00162">ShmemCtl::type</a>, <a class="el" href="veil__datatypes_8h_source.html#l00164">ShmemCtl::veil_lwlock</a>, <a class="el" href="veil__config_8c_source.html#l00082">veil_shmem_context_size()</a>, and <a class="el" href="veil__shmem_8c_source.html#l00085">VeilLWLock</a>.</p>

<p class="reference">Referenced by <a class="el" href="veil__shmem_8c_source.html#l00337">get_cur_context_id()</a>, and <a class="el" href="veil__shmem_8c_source.html#l00240">get_shmem_context()</a>.</p>

</div>
</div>
<a id="a70eb6a014556b540cb3ca9d1102bd9b3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a70eb6a014556b540cb3ca9d1102bd9b3">&#9670;&nbsp;</a></span>get_cur_context_id()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static int get_cur_context_id </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Return the id (index) of the current context for this session. </p>
<dl class="section return"><dt>Returns</dt><dd>The current context id </dd></dl>

<p class="definition">Definition at line <a class="el" href="veil__shmem_8c_source.html#l00337">337</a> of file <a class="el" href="veil__shmem_8c_source.html">veil_shmem.c</a>.</p>

<p class="reference">References <a class="el" href="veil__datatypes_8h_source.html#l00165">ShmemCtl::current_context</a>, <a class="el" href="veil__shmem_8c_source.html#l00101">OTHER_CONTEXT</a>, <a class="el" href="veil__shmem_8c_source.html#l00078">prepared_for_switch</a>, <a class="el" href="veil__shmem_8c_source.html#l00449">shmalloc_init()</a>, and <a class="el" href="veil__datatypes_8h_source.html#l00172">ShmemCtl::xid</a>.</p>

<p class="reference">Referenced by <a class="el" href="veil__shmem_8c_source.html#l00370">get_cur_context()</a>, and <a class="el" href="veil__shmem_8c_source.html#l00552">vl_get_shared_hash()</a>.</p>

</div>
</div>
<a id="ab86d819c1dfe4f25ed4a7094edf473cd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab86d819c1dfe4f25ed4a7094edf473cd">&#9670;&nbsp;</a></span>get_cur_context()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="structMemContext.html">MemContext</a>* get_cur_context </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Return pointer to shared memory allocated for the current context. </p>
<dl class="section return"><dt>Returns</dt><dd>The current context. </dd></dl>

<p class="definition">Definition at line <a class="el" href="veil__shmem_8c_source.html#l00370">370</a> of file <a class="el" href="veil__shmem_8c_source.html">veil_shmem.c</a>.</p>

<p class="reference">References <a class="el" href="veil__datatypes_8h_source.html#l00171">ShmemCtl::context</a>, and <a class="el" href="veil__shmem_8c_source.html#l00337">get_cur_context_id()</a>.</p>

<p class="reference">Referenced by <a class="el" href="veil__shmem_8c_source.html#l00719">vl_force_context_switch()</a>, <a class="el" href="veil__shmem_8c_source.html#l00552">vl_get_shared_hash()</a>, <a class="el" href="veil__shmem_8c_source.html#l00604">vl_prepare_context_switch()</a>, and <a class="el" href="veil__shmem_8c_source.html#l00414">vl_shmalloc()</a>.</p>

</div>
</div>
<a id="a227be00ef6a272b3542f8a557921cc68"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a227be00ef6a272b3542f8a557921cc68">&#9670;&nbsp;</a></span>do_vl_shmalloc()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void* do_vl_shmalloc </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structMemContext.html">MemContext</a> *&#160;</td>
          <td class="paramname"><em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Dynamically allocate a piece of shared memory from the current context, doing no locking. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">context</td><td>The context in which we are operating </td></tr>
    <tr><td class="paramname">size</td><td>The size of the requested piece of memory.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Pointer to dynamically allocated memory. </dd></dl>

<p class="definition">Definition at line <a class="el" href="veil__shmem_8c_source.html#l00387">387</a> of file <a class="el" href="veil__shmem_8c_source.html">veil_shmem.c</a>.</p>

<p class="reference">References <a class="el" href="veil__shmem_8h_source.html#l00062">MemContext::limit</a>, and <a class="el" href="veil__shmem_8h_source.html#l00061">MemContext::next</a>.</p>

<p class="reference">Referenced by <a class="el" href="veil__shmem_8c_source.html#l00449">shmalloc_init()</a>, and <a class="el" href="veil__shmem_8c_source.html#l00414">vl_shmalloc()</a>.</p>

</div>
</div>
<a id="a29b6f83f94963d116e3ae668409d4e64"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a29b6f83f94963d116e3ae668409d4e64">&#9670;&nbsp;</a></span>vl_shmalloc()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void* vl_shmalloc </td>
          <td>(</td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>size</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Dynamically allocate a piece of shared memory from the current context. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">size</td><td>The size of the requested piece of memory.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Pointer to dynamically allocated memory. </dd></dl>

<p class="definition">Definition at line <a class="el" href="veil__shmem_8c_source.html#l00414">414</a> of file <a class="el" href="veil__shmem_8c_source.html">veil_shmem.c</a>.</p>

<p class="reference">References <a class="el" href="veil__shmem_8c_source.html#l00387">do_vl_shmalloc()</a>, <a class="el" href="veil__shmem_8c_source.html#l00370">get_cur_context()</a>, and <a class="el" href="veil__shmem_8c_source.html#l00085">VeilLWLock</a>.</p>

<p class="reference">Referenced by <a class="el" href="veil__bitmap_8c_source.html#l00095">vl_NewBitmap()</a>, <a class="el" href="veil__bitmap_8c_source.html#l00368">vl_NewBitmapArray()</a>, <a class="el" href="veil__datatypes_8c_source.html#l00052">vl_NewInt4()</a>, <a class="el" href="veil__variables_8c_source.html#l00246">vl_NewInt4Array()</a>, and <a class="el" href="veil__datatypes_8c_source.html#l00028">vl_NewRange()</a>.</p>

</div>
</div>
<a id="ae0c62be7edc4694bd88843fb2f1c3374"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae0c62be7edc4694bd88843fb2f1c3374">&#9670;&nbsp;</a></span>vl_free()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void vl_free </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>mem</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Free a piece of shared memory within the current context. </p>
<p>Currently this does nothing as implementation of freeing of shared memory has been deferred.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">mem</td><td>Pointer to the memory to be freed. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="veil__shmem_8c_source.html#l00437">437</a> of file <a class="el" href="veil__shmem_8c_source.html">veil_shmem.c</a>.</p>

<p class="reference">Referenced by <a class="el" href="veil__bitmap_8c_source.html#l00095">vl_NewBitmap()</a>, and <a class="el" href="veil__bitmap_8c_source.html#l00368">vl_NewBitmapArray()</a>.</p>

</div>
</div>
<a id="a34c7062e411af6d7ec1c2120e9e051ef"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a34c7062e411af6d7ec1c2120e9e051ef">&#9670;&nbsp;</a></span>vl_get_shared_hash()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">HTAB* vl_get_shared_hash </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Return the shared hash for the current context. </p>
<dl class="section return"><dt>Returns</dt><dd>Pointer to the HTAB for the current context's shared hash. </dd></dl>

<p class="definition">Definition at line <a class="el" href="veil__shmem_8c_source.html#l00552">552</a> of file <a class="el" href="veil__shmem_8c_source.html">veil_shmem.c</a>.</p>

<p class="reference">References <a class="el" href="veil__shmem_8c_source.html#l00370">get_cur_context()</a>, <a class="el" href="veil__shmem_8c_source.html#l00337">get_cur_context_id()</a>, <a class="el" href="veil__shmem_8c_source.html#l00199">get_hash0()</a>, and <a class="el" href="veil__shmem_8c_source.html#l00216">get_hash1()</a>.</p>

<p class="reference">Referenced by <a class="el" href="veil__interface_8c_source.html#l00145">ensure_init()</a>, <a class="el" href="veil__variables_8c_source.html#l00070">vl_lookup_shared_variable()</a>, <a class="el" href="veil__variables_8c_source.html#l00122">vl_lookup_variable()</a>, and <a class="el" href="veil__variables_8c_source.html#l00167">vl_next_variable()</a>.</p>

</div>
</div>
<a id="a77032dd4e670f5ffcfed0613b636dcfd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a77032dd4e670f5ffcfed0613b636dcfd">&#9670;&nbsp;</a></span>clear_hash()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void clear_hash </td>
          <td>(</td>
          <td class="paramtype">HTAB *&#160;</td>
          <td class="paramname"><em>hash</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Reset one of the shared hashes. </p>
<p>This is one of the final steps in a context switch.</p>
<dl class="section return"><dt>Returns</dt><dd>hash The shared hash that is to be reset. </dd></dl>

<p class="definition">Definition at line <a class="el" href="veil__shmem_8c_source.html#l00582">582</a> of file <a class="el" href="veil__shmem_8c_source.html">veil_shmem.c</a>.</p>

<p class="reference">References <a class="el" href="veil__datatypes_8h_source.html#l00398">VarEntry::key</a>.</p>

<p class="reference">Referenced by <a class="el" href="veil__shmem_8c_source.html#l00719">vl_force_context_switch()</a>, and <a class="el" href="veil__shmem_8c_source.html#l00604">vl_prepare_context_switch()</a>.</p>

</div>
</div>
<a id="a3310bc14291d9f102ade89066450df5a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3310bc14291d9f102ade89066450df5a">&#9670;&nbsp;</a></span>vl_prepare_context_switch()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool vl_prepare_context_switch </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Prepare for a switch to the alternate context. </p>
<p>Switching will only be allowed if there are no transactions that may still be using the context to which we are switching, and there is no other process attempting the switch.</p>
<dl class="section return"><dt>Returns</dt><dd>true if the switch preparation was successful. </dd></dl>

<p class="definition">Definition at line <a class="el" href="veil__shmem_8c_source.html#l00604">604</a> of file <a class="el" href="veil__shmem_8c_source.html">veil_shmem.c</a>.</p>

<p class="reference">References <a class="el" href="veil__shmem_8c_source.html#l00582">clear_hash()</a>, <a class="el" href="veil__datatypes_8h_source.html#l00171">ShmemCtl::context</a>, <a class="el" href="veil__datatypes_8h_source.html#l00165">ShmemCtl::current_context</a>, <a class="el" href="veil__shmem_8c_source.html#l00370">get_cur_context()</a>, <a class="el" href="veil__shmem_8c_source.html#l00199">get_hash0()</a>, <a class="el" href="veil__shmem_8c_source.html#l00216">get_hash1()</a>, <a class="el" href="veil__shmem_8h_source.html#l00061">MemContext::next</a>, <a class="el" href="veil__shmem_8c_source.html#l00101">OTHER_CONTEXT</a>, <a class="el" href="veil__shmem_8c_source.html#l00078">prepared_for_switch</a>, <a class="el" href="veil__datatypes_8h_source.html#l00169">ShmemCtl::switching</a>, <a class="el" href="veil__shmem_8c_source.html#l00085">VeilLWLock</a>, and <a class="el" href="veil__datatypes_8h_source.html#l00172">ShmemCtl::xid</a>.</p>

<p class="reference">Referenced by <a class="el" href="veil__interface_8c_source.html#l02364">veil_perform_reset()</a>.</p>

</div>
</div>
<a id="a9d1285bebe16c01ef93b9c049623a2ca"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9d1285bebe16c01ef93b9c049623a2ca">&#9670;&nbsp;</a></span>vl_complete_context_switch()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool vl_complete_context_switch </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Complete the context switch started by <a class="el" href="veil__shmem_8c.html#a3310bc14291d9f102ade89066450df5a" title="Prepare for a switch to the alternate context. ">vl_prepare_context_switch()</a>. </p>
<p>Raise an ERROR if the context switch cannot be completed.</p>
<dl class="section return"><dt>Returns</dt><dd>true if the context switch is successfully completed. </dd></dl>

<p class="definition">Definition at line <a class="el" href="veil__shmem_8c_source.html#l00678">678</a> of file <a class="el" href="veil__shmem_8c_source.html">veil_shmem.c</a>.</p>

<p class="reference">References <a class="el" href="veil__datatypes_8h_source.html#l00165">ShmemCtl::current_context</a>, <a class="el" href="veil__shmem_8c_source.html#l00101">OTHER_CONTEXT</a>, <a class="el" href="veil__shmem_8c_source.html#l00078">prepared_for_switch</a>, <a class="el" href="veil__datatypes_8h_source.html#l00169">ShmemCtl::switching</a>, <a class="el" href="veil__shmem_8c_source.html#l00085">VeilLWLock</a>, and <a class="el" href="veil__datatypes_8h_source.html#l00172">ShmemCtl::xid</a>.</p>

<p class="reference">Referenced by <a class="el" href="veil__interface_8c_source.html#l02364">veil_perform_reset()</a>.</p>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="ae492088f1f58cd72f518025a5b37a775"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae492088f1f58cd72f518025a5b37a775">&#9670;&nbsp;</a></span>prepared_for_switch</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">bool prepared_for_switch = false</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Whether the current backend is in the process of switching contexts. </p>
<p>If so, it will be setting up the non-current context in readiness for making it available to all other backends. </p>

<p class="definition">Definition at line <a class="el" href="veil__shmem_8c_source.html#l00078">78</a> of file <a class="el" href="veil__shmem_8c_source.html">veil_shmem.c</a>.</p>

<p class="reference">Referenced by <a class="el" href="veil__shmem_8c_source.html#l00337">get_cur_context_id()</a>, <a class="el" href="veil__shmem_8c_source.html#l00678">vl_complete_context_switch()</a>, <a class="el" href="veil__shmem_8c_source.html#l00719">vl_force_context_switch()</a>, and <a class="el" href="veil__shmem_8c_source.html#l00604">vl_prepare_context_switch()</a>.</p>

</div>
</div>
<a id="ad8f74fa4f1ea4cf7a19a63acc93d9821"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad8f74fa4f1ea4cf7a19a63acc93d9821">&#9670;&nbsp;</a></span>VeilLWLock</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">LWLockId VeilLWLock = 0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>The LWLock that Veil will use for managing concurrent access to shared memory. </p>
<p>It is initialised in <a class="el" href="veil__shmem_8c.html#a6822496ec3bdaec728859d44564ed1b7" title="Veil&#39;s startup function. ">_PG_init()</a> to a lock id that is distinct from any that will be dynamically allocated. </p>

<p class="definition">Definition at line <a class="el" href="veil__shmem_8c_source.html#l00085">85</a> of file <a class="el" href="veil__shmem_8c_source.html">veil_shmem.c</a>.</p>

<p class="reference">Referenced by <a class="el" href="veil__shmem_8c_source.html#l00141">_PG_init()</a>, <a class="el" href="veil__shmem_8c_source.html#l00240">get_shmem_context()</a>, <a class="el" href="veil__shmem_8c_source.html#l00449">shmalloc_init()</a>, <a class="el" href="veil__shmem_8c_source.html#l00678">vl_complete_context_switch()</a>, <a class="el" href="veil__shmem_8c_source.html#l00719">vl_force_context_switch()</a>, <a class="el" href="veil__shmem_8c_source.html#l00604">vl_prepare_context_switch()</a>, and <a class="el" href="veil__shmem_8c_source.html#l00414">vl_shmalloc()</a>.</p>

</div>
</div>
<a id="abde9c524b373dd3b0f8da340ed52061a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abde9c524b373dd3b0f8da340ed52061a">&#9670;&nbsp;</a></span>InitialLWLock</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">LWLockId InitialLWLock = 0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>The LWLock to be used while initially setting up shared memory and allocating a veil database-specific LWLock. </p>
<p>Initialised in _PG_Init() </p>

<p class="definition">Definition at line <a class="el" href="veil__shmem_8c_source.html#l00092">92</a> of file <a class="el" href="veil__shmem_8c_source.html">veil_shmem.c</a>.</p>

<p class="reference">Referenced by <a class="el" href="veil__shmem_8c_source.html#l00141">_PG_init()</a>, and <a class="el" href="veil__shmem_8c_source.html#l00449">shmalloc_init()</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="veil__shmem_8c.html">veil_shmem.c</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
