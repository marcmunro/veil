<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Veil: The Demo Code</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Veil
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('demo-code.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">The Demo Code </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="demo-codesec"></a>
The Code</h1>
<h2><a class="anchor" id="demo-code-veil-init"></a>
veil.veil_demo_init(performing_reset bool)</h2>
<p>This function is called at the start of each session, and whenever <a class="el" href="API-control.html#API-control-reset">veil_perform_reset()</a> is called. The parameter, doing_reset, is false when called to initialise a session and true when called from <a class="el" href="veil__funcs_8h.html#aba68f965e211edd6b2f06591e0fc1ef6" title="veil_perform_reset() returns bool Reset veil shared memory for this database. ">veil_perform_reset()</a>. It is registered with <a class="el" href="API-control.html#API-control-init">veil_init(doing_reset bool)</a> through the <code>veil.veil_demo_init_fns</code> table which is created as an inherited table of <code>veil.veil_init_fns</code>. By registering the initialisation functions using a veil_demo-specific inherited table, when the veil_demo extension is dropped, so is the registration data for <a class="el" href="demo-code.html#demo-code-veil-init">veil.veil_demo_init(performing_reset bool)</a>.</p>
 <div class="fragment"><div class="line"><span class="keyword">function</span> veil.veil_demo_init(doing_reset <span class="keywordtype">bool</span>) returns <span class="keywordtype">bool</span> as <span class="stringliteral">&#39;</span></div><div class="line"><span class="stringliteral">declare</span></div><div class="line"><span class="stringliteral">    exists_privs_range bool;</span></div><div class="line"><span class="stringliteral">    exists_roles_range bool;</span></div><div class="line"><span class="stringliteral">    exists_role_privs  bool;</span></div><div class="line"><span class="stringliteral">    exists_det_types_range bool;</span></div><div class="line"><span class="stringliteral">    exists_det_types_privs bool;</span></div><div class="line"><span class="stringliteral">    init_reqd bool;</span></div><div class="line"><span class="stringliteral">    dummy     bool;</span></div><div class="line"><span class="stringliteral">    dummy2    bool;</span></div><div class="line"><span class="stringliteral">    dummyint  int4;</span></div><div class="line"><span class="stringliteral">    _count    int4;</span></div><div class="line"><span class="stringliteral">begin</span></div><div class="line"><span class="stringliteral">    -- Declare all shared variables.</span></div><div class="line"><span class="stringliteral"></span></div><div class="line"><span class="stringliteral">    select into exists_privs_range, exists_roles_range,</span></div><div class="line"><span class="stringliteral">        exists_role_privs, exists_det_types_range,</span></div><div class="line"><span class="stringliteral">        exists_det_types_privs</span></div><div class="line"><span class="stringliteral">           veil.share(&#39;</span><span class="stringliteral">&#39;privs_range&#39;</span><span class="stringliteral">&#39;), veil.share(&#39;</span><span class="stringliteral">&#39;roles_range&#39;</span><span class="stringliteral">&#39;),</span></div><div class="line"><span class="stringliteral">       veil.share(&#39;</span><span class="stringliteral">&#39;role_privs&#39;</span><span class="stringliteral">&#39;), veil.share(&#39;</span><span class="stringliteral">&#39;det_types_range&#39;</span><span class="stringliteral">&#39;),</span></div><div class="line"><span class="stringliteral">       veil.share(&#39;</span><span class="stringliteral">&#39;det_types_privs&#39;</span><span class="stringliteral">&#39;);</span></div><div class="line"><span class="stringliteral"></span></div><div class="line"><span class="stringliteral">    init_reqd = not (exists_privs_range and exists_role_privs and</span></div></div><!-- fragment --></p>
<p>The first task of <a class="el" href="veil__funcs_8h.html#a1eb95ff8b9c26ea5494f61dde6f9c31b" title="veil_init(doing_reset bool) returns bool Initialise or reset a veil session. ">veil_init()</a> is to declare a set of Veil shared variables. This is done by calling <a class="el" href="API-variables.html#API-variables-share">share(name text)</a>. This function returns true if the variable already exists, and creates the variable and returns false, if not.</p>
<p>These variables are defined as shared because they will be identical for each session. Making them shared means that only one session has to deal with the overhead of their initialisation.</p>
 <div class="fragment"><div class="line">    init_reqd = not (exists_privs_range and exists_role_privs and</div><div class="line">             exists_role_privs and exists_det_types_range and</div><div class="line">             exists_det_types_privs);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> init_reqd or doing_reset then</div><div class="line">        -- Load ranges <span class="keywordflow">for</span> privs and roles.</div><div class="line">        select into dummyint</div><div class="line">               veil.init_range(<span class="stringliteral">&#39;&#39;</span>roles_range<span class="stringliteral">&#39;&#39;</span>, min(role_id), max(role_id))</div><div class="line">        from   hidden.roles;</div><div class="line"></div><div class="line">        select into dummyint</div><div class="line">               veil.init_range(<span class="stringliteral">&#39;&#39;</span>privs_range<span class="stringliteral">&#39;&#39;</span>, min(privilege_id), </div><div class="line">                      max(privilege_id))</div><div class="line">        from   hidden.privileges;</div><div class="line"></div><div class="line">    -- Load range <span class="keywordflow">for</span> detail_types</div><div class="line">        select into dummyint</div><div class="line">               veil.init_range(<span class="stringliteral">&#39;&#39;</span>det_types_range<span class="stringliteral">&#39;&#39;</span>, </div><div class="line">                       min(detail_type_id), max(detail_type_id))</div><div class="line">        from   hidden.detail_types;</div><div class="line"></div><div class="line">    -- Initialise array of required privs <span class="keywordflow">for</span> detail_types</div><div class="line">        select into dummy</div><div class="line">               veil.init_int4array(<span class="stringliteral">&#39;&#39;</span>det_types_privs<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>det_types_range<span class="stringliteral">&#39;&#39;</span>);</div><div class="line">        select into _count</div><div class="line">               count(veil.int4array_set(<span class="stringliteral">&#39;&#39;</span>det_types_privs<span class="stringliteral">&#39;&#39;</span>, </div><div class="line">                                detail_type_id, required_privilege_id))</div><div class="line">        from   hidden.detail_types;</div><div class="line"></div><div class="line">        -- Initialise role_privs bitmap_array</div><div class="line">        select into dummy</div><div class="line">               veil.init_bitmap_array(<span class="stringliteral">&#39;&#39;</span>role_privs<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>roles_range<span class="stringliteral">&#39;&#39;</span>, </div><div class="line">                         <span class="stringliteral">&#39;&#39;</span>privs_range<span class="stringliteral">&#39;&#39;</span>);</div><div class="line"></div><div class="line">        -- Populate role_privs bitmap_array</div><div class="line">        select into _count</div><div class="line">               count(veil.bitmap_array_setbit(<span class="stringliteral">&#39;&#39;</span>role_privs<span class="stringliteral">&#39;&#39;</span>, </div><div class="line">                             role_id, privilege_id))</div><div class="line">        from   hidden.role_privileges;</div><div class="line"></div><div class="line">    end <span class="keywordflow">if</span>;</div></div><!-- fragment --></p>
<p>We then check whether the shared variables must be initialised. We will initialise them if they have not already been initialised by another session, or if we are performing a reset (see <a class="el" href="API-control.html#API-control-reset">veil_perform_reset()</a>).</p>
<p>Each variable is initialised in its own way.</p>
<p>Ranges are set by a single call to <a class="el" href="API-simple.html#API-basic-init-range">init_range(name text, min int4, max int4)</a>. Ranges are used to create bitmap and array types of a suitable size.</p>
<p>Int4Arrays are used to record mappings of one integer to another. In the demo, they are used to record the mapping of detail_type_id to required_privilege_id. We use this variable so that we can look-up the privilege required to access a given project_detail or person_detail without having to explicitly fetch from attribute_detail_types.</p>
<p>Int4Arrays are initialised by a call to <a class="el" href="API-int-arrays.html#API-intarray-init">init_int4array(arrayname text, range text)</a>, and are populated by calling <a class="el" href="API-int-arrays.html#API-intarray-set">int4array_set(arrayname text, idx int4, value int4)</a> for each value to be recorded. Note that rather than using a cursor to loop through each detail_type record, we use select count(). This requires less code and has the same effect.</p>
<p>We use a <a class="el" href="structBitmapArray.html" title="Subtype of Object for storing bitmap arrays. ">BitmapArray</a> to record the set of privileges for each role. Its initialisation and population is handled in much the same way as described above for Int4Arrays, using the functions <a class="el" href="API-bitmap-arrays.html#API-bmarray-init">init_bitmap_array(bmarray text, array_range text, bitmap_range text)</a> and <a class="el" href="API-bitmap-arrays.html#API-bmarray-setbit">bitmap_array_setbit(bmarray text, arr_idx int4, bitno int4)</a>.</p>
<p><div class="fragment"><div class="line"></div><div class="line">    -- Declare important session variables, so that we <span class="keywordflow">do</span> not </div><div class="line">    -- <span class="keyword">get</span> odd, undefined variable, error messages.</div><div class="line">    select into dummyint, dummy, dummy2</div><div class="line">       veil.int4_set(<span class="stringliteral">&#39;&#39;</span>person_id<span class="stringliteral">&#39;&#39;</span>,  null),</div><div class="line">       veil.init_bitmap(<span class="stringliteral">&#39;&#39;</span>global_context<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>privs_range<span class="stringliteral">&#39;&#39;</span>),</div><div class="line">       veil.init_bitmap_hash(<span class="stringliteral">&#39;&#39;</span>project_context<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>privs_range<span class="stringliteral">&#39;&#39;</span>);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;                </div><div class="line">end;</div><div class="line"><span class="stringliteral">&#39; language plpgsql volatile security definer;</span></div></div><!-- fragment --></p>
<p>The final section of code defines and initialises a set of session variables. These are defined here to avoid getting undefined variable errors from any access function that may be called before an authenticated connection has been established.</p>
<p>Note that this and all Veil related functions are defined with <code>security definer</code> attributes. This means that the function will be executed with the privileges of the function's owner, rather than those of the invoker. This is absolutely critical as the invoker must have no privileges on the base objects, or on the raw Veil functions themselves. The only access to objects protected by Veil must be through user-defined functions and views.</p>
<h2><a class="anchor" id="demo-code-connect-person"></a>
connect_person(_person_id int4)</h2>
<p>This function is used to establish a connection from a specific person. In a real application this function would be provided with some form of authentication token for the user. For the sake of simplicity the demo allows unauthenticated connection requests.</p>
<p><div class="fragment"><div class="line"><span class="keyword">function</span> connect_person(_person_id int4) returns <span class="keywordtype">bool</span> as <span class="stringliteral">&#39;</span></div><div class="line"><span class="stringliteral">declare</span></div><div class="line"><span class="stringliteral">    dummy    int4;</span></div><div class="line"><span class="stringliteral">    _connect bool;</span></div><div class="line"><span class="stringliteral">    proj_roles record;</span></div><div class="line"><span class="stringliteral">    last_proj int4;</span></div><div class="line"><span class="stringliteral">    first_rec bool;</span></div><div class="line"><span class="stringliteral">begin</span></div><div class="line"><span class="stringliteral">    -- In reality this function would require some authentication token such </span></div><div class="line"><span class="stringliteral">    -- as a password.  This is just a dumb demo version.</span></div><div class="line"><span class="stringliteral"></span></div><div class="line"><span class="stringliteral">    select into _connect disconnect_person();</span></div><div class="line"><span class="stringliteral"></span></div><div class="line"><span class="stringliteral">    -- Test whether provided person exists.  This is where we would, in a</span></div><div class="line"><span class="stringliteral">    -- real version, do proper authentication.</span></div><div class="line"><span class="stringliteral">    select into dummy 1</span></div><div class="line"><span class="stringliteral">    from   hidden.persons</span></div><div class="line"><span class="stringliteral">    where  person_id = _person_id;</span></div><div class="line"><span class="stringliteral"></span></div><div class="line"><span class="stringliteral">    if found then</span></div><div class="line"><span class="stringliteral">    -- The person exists and passes authentication</span></div><div class="line"><span class="stringliteral"></span></div><div class="line"><span class="stringliteral">    -- From the persons roles set the global_context bitmap.</span></div><div class="line"><span class="stringliteral">    select into dummy</span></div><div class="line"><span class="stringliteral">           count(veil.union_from_bitmap_array(&#39;</span><span class="stringliteral">&#39;global_context&#39;</span><span class="stringliteral">&#39;,</span></div><div class="line"><span class="stringliteral">                          &#39;</span><span class="stringliteral">&#39;role_privs&#39;</span><span class="stringliteral">&#39;, role_id))</span></div><div class="line"><span class="stringliteral">    from   hidden.person_roles</span></div><div class="line"><span class="stringliteral">    where  person_id = _person_id;</span></div><div class="line"><span class="stringliteral"></span></div><div class="line"><span class="stringliteral">    -- Check that user has can_connect privilege</span></div><div class="line"><span class="stringliteral">    select into _connect</span></div><div class="line"><span class="stringliteral">        veil.bitmap_testbit(&#39;</span><span class="stringliteral">&#39;global_context&#39;</span><span class="stringliteral">&#39;, 10100);</span></div><div class="line"><span class="stringliteral"></span></div><div class="line"><span class="stringliteral">    if not _connect then</span></div><div class="line"><span class="stringliteral">        select into _connect disconnect_person();</span></div><div class="line"><span class="stringliteral">        return false;</span></div><div class="line"><span class="stringliteral">    end if;</span></div><div class="line"><span class="stringliteral"></span></div><div class="line"><span class="stringliteral"></span></div><div class="line"><span class="stringliteral">    -- From the persons assignments set the project_context bitmap hash.</span></div><div class="line"><span class="stringliteral">    select into dummy</span></div><div class="line"><span class="stringliteral">           count(veil.union_into_bitmap_hash(&#39;</span><span class="stringliteral">&#39;project_context&#39;</span><span class="stringliteral">&#39;,</span></div><div class="line"><span class="stringliteral">            project_id::text,</span></div><div class="line"><span class="stringliteral">            veil.bitmap_from_array(&#39;</span><span class="stringliteral">&#39;scratch_bitmap&#39;</span><span class="stringliteral">&#39;,</span></div><div class="line"><span class="stringliteral">                           &#39;</span><span class="stringliteral">&#39;role_privs&#39;</span><span class="stringliteral">&#39;, role_id)))</span></div><div class="line"><span class="stringliteral">    from   hidden.assignments</span></div><div class="line"><span class="stringliteral">    where  person_id = _person_id;</span></div><div class="line"><span class="stringliteral"></span></div><div class="line"><span class="stringliteral">    -- Finally, record the person_id for the connection.</span></div><div class="line"><span class="stringliteral">    select into dummy veil.int4_set(&#39;</span><span class="stringliteral">&#39;person_id&#39;</span><span class="stringliteral">&#39;, _person_id);</span></div><div class="line"><span class="stringliteral"></span></div><div class="line"><span class="stringliteral">    return true;</span></div><div class="line"><span class="stringliteral">    else</span></div><div class="line"><span class="stringliteral">    return false;</span></div><div class="line"><span class="stringliteral">    end if;</span></div><div class="line"><span class="stringliteral"></span></div><div class="line"><span class="stringliteral">end;</span></div><div class="line"><span class="stringliteral">&#39;</span> language plpgsql <span class="keyword">volatile</span> security definer;</div></div><!-- fragment --></p>
<p>This function identifies the user, ensures that they have can_connect privilege. It initialises the global_context bitmap to contain the union of all privileges for each role the person is assigned through person_roles. It also sets up a bitmap hash containing a bitmap of privileges for each project to which the person is assigned.</p>
<h2><a class="anchor" id="demo-code-global-priv"></a>
i_have_global_priv(priv_id int4)</h2>
<p>This function is used to determine whether a user has a specified privilege in the global context. It tests that the user is connected using <a class="el" href="API-simple.html#API-basic-int4-get">int4_get(name text)</a>, and then checks whether the specified privilege is present in the <code>global_context</code> bitmap.</p>
<p><div class="fragment"><div class="line"><span class="keyword">function</span> i_have_global_priv(priv_id int4) returns <span class="keywordtype">bool</span> as <span class="stringliteral">&#39;</span></div><div class="line"><span class="stringliteral">declare</span></div><div class="line"><span class="stringliteral">    connection_id int4;</span></div><div class="line"><span class="stringliteral">    result bool;</span></div><div class="line"><span class="stringliteral">begin</span></div><div class="line"><span class="stringliteral">    select into connection_id, result </span></div><div class="line"><span class="stringliteral">           veil.int4_get(&#39;</span><span class="stringliteral">&#39;person_id&#39;</span><span class="stringliteral">&#39;), </span></div><div class="line"><span class="stringliteral">           veil.bitmap_testbit(&#39;</span><span class="stringliteral">&#39;global_context&#39;</span><span class="stringliteral">&#39;, priv_id);</span></div><div class="line"><span class="stringliteral">    if connection_id is null then</span></div><div class="line"><span class="stringliteral">    return false;</span></div><div class="line"><span class="stringliteral">    else</span></div><div class="line"><span class="stringliteral">        return result;</span></div><div class="line"><span class="stringliteral">    end if;</span></div><div class="line"><span class="stringliteral">end;</span></div><div class="line"><span class="stringliteral">&#39;</span> language plpgsql <span class="keyword">volatile</span> security definer;</div></div><!-- fragment --></p>
<p>The following example shows this function in use by the secured view, <code>privileges</code>:</p>
<p><div class="fragment"><div class="line">create view privileges(</div><div class="line">       privilege_id,</div><div class="line">       privilege_name) as</div><div class="line">select privilege_id,</div><div class="line">       privilege_name</div><div class="line">from   hidden.privileges</div><div class="line">where  i_have_global_priv(10001);</div><div class="line"></div><div class="line">create rule ii_privileges as</div><div class="line">on insert to privileges</div><div class="line"><span class="keywordflow">do</span> instead </div><div class="line">    insert into hidden.privileges</div><div class="line">       (privilege_id, privilege_name)</div><div class="line">    select <span class="keyword">new</span>.privilege_id, <span class="keyword">new</span>.privilege_name </div><div class="line">    where  i_have_global_priv(10002);</div><div class="line"></div><div class="line">create rule iu_privileges as</div><div class="line">on update to privileges</div><div class="line"><span class="keywordflow">do</span> instead</div><div class="line">    update hidden.privileges</div><div class="line">    <span class="keyword">set</span>    privilege_name = <span class="keyword">new</span>.privilege_name,</div><div class="line">       privilege_id = <span class="keyword">new</span>.privilege_id</div><div class="line">    where  privilege_id = old.privilege_id</div><div class="line">    and    i_have_global_priv(10003);</div><div class="line"> </div><div class="line">create rule id_privileges as</div><div class="line">on <span class="keyword">delete</span> to privileges</div><div class="line"><span class="keywordflow">do</span> instead</div><div class="line">    <span class="keyword">delete</span> from hidden.privileges</div><div class="line">    where  privilege_id = old.privilege_id</div><div class="line">    and    i_have_global_priv(10004);</div><div class="line"></div><div class="line">grant select, insert, update, <span class="keyword">delete</span> on privileges to <span class="keyword">public</span>;    </div></div><!-- fragment --></p>
<p>The privileges used above are <code>select_privileges</code> (10001), <code>insert_privileges</code> (10002), <code>update_privileges</code> (10003), and <code>delete_privileges</code> (10004).</p>
<h2><a class="anchor" id="demo-code-personal-priv"></a>
i_have_personal_priv(priv_id int4, person_id int4)</h2>
<p>This function determines whether a user has a specified privilege to a specified user's data, in the global or personal contexts. It performs the same tests as for <a class="el" href="demo-code.html#demo-code-global-priv">i_have_global_priv(priv_id int4)</a>. If the user does not have access in the global context, and the connected user is the same user as the owner of the data we are looking at, then we test whether the specified privilege exists in the <code>role_privs</code> bitmap array for the <code>Personal Context</code> role.</p>
 <div class="fragment"><div class="line"><span class="keyword">function</span> i_have_personal_priv(priv_id int4, person_id int4) returns <span class="keywordtype">bool</span> as <span class="stringliteral">&#39;</span></div><div class="line"><span class="stringliteral">declare</span></div><div class="line"><span class="stringliteral">    connection_id int4;</span></div><div class="line"><span class="stringliteral">    result bool;</span></div><div class="line"><span class="stringliteral">begin</span></div><div class="line"><span class="stringliteral">    select into connection_id, result </span></div><div class="line"><span class="stringliteral">           veil.int4_get(&#39;</span><span class="stringliteral">&#39;person_id&#39;</span><span class="stringliteral">&#39;), </span></div><div class="line"><span class="stringliteral">           veil.bitmap_testbit(&#39;</span><span class="stringliteral">&#39;global_context&#39;</span><span class="stringliteral">&#39;, priv_id);</span></div><div class="line"><span class="stringliteral">    if connection_id is null then</span></div><div class="line"><span class="stringliteral">    -- No-one is connected</span></div><div class="line"><span class="stringliteral">    return false;</span></div><div class="line"><span class="stringliteral">    else</span></div><div class="line"><span class="stringliteral">    if result then</span></div><div class="line"><span class="stringliteral">        -- We have the required privilege in global context.  No need</span></div><div class="line"><span class="stringliteral">        -- to check any further</span></div><div class="line"><span class="stringliteral">        return true;</span></div><div class="line"><span class="stringliteral">    else</span></div><div class="line"><span class="stringliteral">        if person_id = connection_id then</span></div><div class="line"><span class="stringliteral">        -- We are connected as the owner of this record.  Check</span></div><div class="line"><span class="stringliteral">        -- whether we have the required privilege in personal </span></div><div class="line"><span class="stringliteral">        -- context.</span></div><div class="line"><span class="stringliteral">        select into result</span></div><div class="line"><span class="stringliteral">                   veil.bitmap_array_testbit(&#39;</span><span class="stringliteral">&#39;role_privs&#39;</span><span class="stringliteral">&#39;, </span></div><div class="line"><span class="stringliteral">                            11002, priv_id);</span></div><div class="line"><span class="stringliteral">        return result;</span></div><div class="line"><span class="stringliteral">        else</span></div><div class="line"><span class="stringliteral">        -- We have no personal context rights to this record</span></div><div class="line"><span class="stringliteral">        return false;</span></div><div class="line"><span class="stringliteral">        end if;</span></div><div class="line"><span class="stringliteral">    end if;</span></div><div class="line"><span class="stringliteral">    end if;</span></div><div class="line"><span class="stringliteral">end;</span></div><div class="line"><span class="stringliteral">&#39;</span> language plpgsql <span class="keyword">volatile</span> security definer;</div></div><!-- fragment --></p>
<p>Here is an example of this function in use from the persons secured view:</p>
<p><div class="fragment"><div class="line">create view persons(</div><div class="line">       person_id,</div><div class="line">       person_name) as</div><div class="line">select person_id,</div><div class="line">       person_name</div><div class="line">from   hidden.persons</div><div class="line">where  i_have_personal_priv(10013, person_id);</div><div class="line"></div><div class="line">create rule ii_persons as</div><div class="line">on insert to persons</div><div class="line"><span class="keywordflow">do</span> instead </div><div class="line">    insert into hidden.persons</div><div class="line">       (person_id, person_name)</div><div class="line">    select <span class="keyword">new</span>.person_id, <span class="keyword">new</span>.person_name</div><div class="line">    where  i_have_personal_priv(10014, <span class="keyword">new</span>.person_id);</div><div class="line"></div><div class="line">create rule iu_persons as</div><div class="line">on update to persons</div><div class="line"><span class="keywordflow">do</span> instead</div><div class="line">    update hidden.persons</div><div class="line">    <span class="keyword">set</span>    person_id = <span class="keyword">new</span>.person_id,</div><div class="line">       person_name = <span class="keyword">new</span>.person_name</div><div class="line">    where  person_id = old.person_id</div><div class="line">    and    i_have_personal_priv(10015, old.person_id);</div><div class="line"> </div><div class="line">create rule id_persons as</div><div class="line">on <span class="keyword">delete</span> to persons</div><div class="line"><span class="keywordflow">do</span> instead</div><div class="line">    <span class="keyword">delete</span> from hidden.persons</div><div class="line">    where  person_id = old.person_id</div><div class="line">    and    i_have_personal_priv(10016, old.person_id);</div><div class="line"></div><div class="line">grant select, insert, update, <span class="keyword">delete</span> on persons to <span class="keyword">public</span>;    </div></div><!-- fragment --></p>
<h2><a class="anchor" id="demo-code-project-priv"></a>
i_have_project_priv(priv_id int4, project_id int4)</h2>
<p>This function determines whether a user has a specified privilege in the global or project contexts. If the user does not have the global privilege, we check whether they have the privilege defined in the project_context <a class="el" href="structBitmapHash.html" title="Subtype of Object for storing bitmap hashes. ">BitmapHash</a>.</p>
 <div class="fragment"><div class="line"><span class="keyword">function</span> i_have_project_priv(priv_id int4, project_id int4) returns <span class="keywordtype">bool</span> as <span class="stringliteral">&#39;</span></div><div class="line"><span class="stringliteral">declare</span></div><div class="line"><span class="stringliteral">    connection_id int4;</span></div><div class="line"><span class="stringliteral">    result bool;</span></div><div class="line"><span class="stringliteral">begin</span></div><div class="line"><span class="stringliteral">    select into connection_id, result </span></div><div class="line"><span class="stringliteral">           veil.int4_get(&#39;</span><span class="stringliteral">&#39;person_id&#39;</span><span class="stringliteral">&#39;), </span></div><div class="line"><span class="stringliteral">           veil.bitmap_testbit(&#39;</span><span class="stringliteral">&#39;global_context&#39;</span><span class="stringliteral">&#39;, priv_id);</span></div><div class="line"><span class="stringliteral">    if connection_id is null then</span></div><div class="line"><span class="stringliteral">    -- No-one is connected</span></div><div class="line"><span class="stringliteral">    return false;</span></div><div class="line"><span class="stringliteral">    else</span></div><div class="line"><span class="stringliteral">    if result then</span></div><div class="line"><span class="stringliteral">        -- We have the required privilege in global context.  No need</span></div><div class="line"><span class="stringliteral">        -- to check any further</span></div><div class="line"><span class="stringliteral">        return true;</span></div><div class="line"><span class="stringliteral">    else</span></div><div class="line"><span class="stringliteral">        select into result</span></div><div class="line"><span class="stringliteral">            veil.bitmap_hash_testbit(&#39;</span><span class="stringliteral">&#39;project_context&#39;</span><span class="stringliteral">&#39;, </span></div><div class="line"><span class="stringliteral">                         project_id::text, priv_id);</span></div><div class="line"><span class="stringliteral">        return result;</span></div><div class="line"><span class="stringliteral">    end if;</span></div><div class="line"><span class="stringliteral">    end if;</span></div><div class="line"><span class="stringliteral">end;</span></div><div class="line"><span class="stringliteral">&#39;</span> language plpgsql <span class="keyword">volatile</span> security definer;</div></div><!-- fragment --></p>
<p>Here is an example of this function in use from the instead-of insert trigger for the projects secured view:</p>
<p><div class="fragment"><div class="line">create rule ii_projects as</div><div class="line">on insert to projects</div><div class="line"><span class="keywordflow">do</span> instead </div><div class="line">    insert into hidden.projects</div><div class="line">       (project_id, project_name)</div><div class="line">    select <span class="keyword">new</span>.project_id, <span class="keyword">new</span>.project_name</div><div class="line">    where  i_have_project_priv(10018, <span class="keyword">new</span>.project_id);</div></div><!-- fragment --></p>
<h2><a class="anchor" id="demo-code-proj-pers-priv"></a>
i_have_proj_or_pers_priv(priv_id int4, project_id int4, person_id int4)</h2>
<p>This function checks all privileges. It starts with the cheapest check first, and short-circuits as soon as a privilege is found.</p>
 <div class="fragment"><div class="line"><span class="keyword">function</span> i_have_proj_or_pers_priv(</div><div class="line">    priv_id int4, project_id int4, person_id int4) returns <span class="keywordtype">bool</span> as <span class="stringliteral">&#39;</span></div><div class="line"><span class="stringliteral">declare</span></div><div class="line"><span class="stringliteral">    connection_id int4;</span></div><div class="line"><span class="stringliteral">    result bool;</span></div><div class="line"><span class="stringliteral">begin</span></div><div class="line"><span class="stringliteral">    select into connection_id, result </span></div><div class="line"><span class="stringliteral">           veil.int4_get(&#39;</span><span class="stringliteral">&#39;person_id&#39;</span><span class="stringliteral">&#39;), </span></div><div class="line"><span class="stringliteral">           veil.bitmap_testbit(&#39;</span><span class="stringliteral">&#39;global_context&#39;</span><span class="stringliteral">&#39;, priv_id);</span></div><div class="line"><span class="stringliteral">    if connection_id is null then</span></div><div class="line"><span class="stringliteral">    -- No-one is connected</span></div><div class="line"><span class="stringliteral">    return false;</span></div><div class="line"><span class="stringliteral">    else</span></div><div class="line"><span class="stringliteral">    if result then</span></div><div class="line"><span class="stringliteral">        -- We have the required privilege in global context.  No need</span></div><div class="line"><span class="stringliteral">        -- to check any further</span></div><div class="line"><span class="stringliteral">        return true;</span></div><div class="line"><span class="stringliteral">    else</span></div><div class="line"><span class="stringliteral">        if person_id = connection_id then</span></div><div class="line"><span class="stringliteral">        -- We are connected as the owner of this record.  Check</span></div><div class="line"><span class="stringliteral">        -- whether we have the required privilege in personal </span></div><div class="line"><span class="stringliteral">        -- context.</span></div><div class="line"><span class="stringliteral">        select into result</span></div><div class="line"><span class="stringliteral">                   veil.bitmap_array_testbit(&#39;</span><span class="stringliteral">&#39;role_privs&#39;</span><span class="stringliteral">&#39;, </span></div><div class="line"><span class="stringliteral">                            11002, priv_id);</span></div><div class="line"><span class="stringliteral">        return result;</span></div><div class="line"><span class="stringliteral">        end if;</span></div><div class="line"><span class="stringliteral">        select into result</span></div><div class="line"><span class="stringliteral">            veil.bitmap_hash_testbit(&#39;</span><span class="stringliteral">&#39;project_context&#39;</span><span class="stringliteral">&#39;, </span></div><div class="line"><span class="stringliteral">                         project_id::text, priv_id);</span></div><div class="line"><span class="stringliteral">        return result;</span></div><div class="line"><span class="stringliteral">        -- We have no personal context rights to this record</span></div><div class="line"><span class="stringliteral">        -- so check project context</span></div><div class="line"><span class="stringliteral">        return false;</span></div><div class="line"><span class="stringliteral">    end if;</span></div><div class="line"><span class="stringliteral">    end if;</span></div><div class="line"><span class="stringliteral">end;</span></div><div class="line"><span class="stringliteral">&#39;</span> language plpgsql <span class="keyword">volatile</span> security definer;</div></div><!-- fragment --></p>
<p>Here is an example of this function in use from the instead-of update trigger for the assignments secured view:</p>
<p><div class="fragment"><div class="line">create rule ii_assignments as</div><div class="line">on insert to assignments</div><div class="line"><span class="keywordflow">do</span> instead </div><div class="line">    insert into hidden.assignments</div><div class="line">       (project_id, person_id, role_id)</div><div class="line">    select <span class="keyword">new</span>.project_id, <span class="keyword">new</span>.person_id, <span class="keyword">new</span>.role_id</div><div class="line">    where  i_have_proj_or_pers_priv(10026, <span class="keyword">new</span>.project_id, <span class="keyword">new</span>.person_id);</div><div class="line"></div><div class="line">create rule iu_assignments as</div><div class="line">on update to assignments</div><div class="line"><span class="keywordflow">do</span> instead</div><div class="line">    update hidden.assignments</div><div class="line">    <span class="keyword">set</span>    project_id = <span class="keyword">new</span>.project_id,</div><div class="line">       person_id = <span class="keyword">new</span>.person_id, </div><div class="line">       role_id = <span class="keyword">new</span>.person_id</div><div class="line">    where  project_id = old.project_id</div><div class="line">    and    person_id = old.person_id</div><div class="line">    and    i_have_proj_or_pers_priv(10027, old.project_id, old.person_id);</div></div><!-- fragment --></p>
<h2><a class="anchor" id="demo-code-pers-detail-priv"></a>
i_have_person_detail_priv(detail_id int4, person_id int4)</h2>
<p>This function is used to determine which types of person details are accessible to each user. This provides distinct access controls to each attribute that may be recorded for a person.</p>
 <div class="fragment"><div class="line"><span class="keyword">function</span> i_have_person_detail_priv(detail_id int4, person_id int4) returns <span class="keywordtype">bool</span> as <span class="stringliteral">&#39;</span></div><div class="line"><span class="stringliteral">declare</span></div><div class="line"><span class="stringliteral">    result bool;</span></div><div class="line"><span class="stringliteral">begin</span></div><div class="line"><span class="stringliteral">    select into result </span></div><div class="line"><span class="stringliteral">       i_have_personal_priv(veil.int4array_get(&#39;</span><span class="stringliteral">&#39;det_types_privs&#39;</span><span class="stringliteral">&#39;, detail_id),</span></div><div class="line"><span class="stringliteral">                person_id);</span></div><div class="line"><span class="stringliteral">    return result;</span></div><div class="line"><span class="stringliteral">end;</span></div><div class="line"><span class="stringliteral">&#39;</span> language plpgsql <span class="keyword">volatile</span> security definer;</div></div><!-- fragment --></p>
<p>The function is shown in use, below, in the instead-of delete trigger for person_details. Note that two distinct access functions are being used here.</p>
<p><div class="fragment"><div class="line">create rule id_person_details as</div><div class="line">on <span class="keyword">delete</span> to person_details</div><div class="line"><span class="keywordflow">do</span> instead</div><div class="line">    <span class="keyword">delete</span> from hidden.person_details</div><div class="line">    where  person_id = old.person_id</div><div class="line">    and    detail_type_id = old.detail_type_id</div><div class="line">    and    i_have_personal_priv(10040, old.person_id)</div><div class="line">    and    i_have_person_detail_priv(old.detail_type_id, old.person_id);</div></div><!-- fragment --></p>
<p>Next: <a class="el" href="demo-uninstall.html">Removing The Demo Database</a> </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Veil</a></li><li class="navelem"><a class="el" href="Demo.html">A Full Example Application: The Veil Demo</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
